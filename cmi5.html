<!DOCTYPE html>
<head>
    <title>CMI5 Wrapper</title>
    <script type="text/javascript" src="js/xapiwrapper.min.js"></script>
    <script type="text/javascript">
        function makeBasicStatement(stmtActor, verb, activityID) {
            var stmt = new ADL.XAPIStatement(stmtActor, verb, activityID);
            stmt.timestamp = (new Date()).toISOString();
            stmt.generateId();
            return stmt;
        }
        
        function makePassedStatement(stmtActor, verb, activityID, scaledScore) {
            var stmt = makeBasicStatement(stmtActor, verb, activityID);
            stmt.result = {};
            stmt.result.duration = "PT0H0M27S";
            stmt.result.success = true;
            if (scaledScore !== "") {
                stmt.result.score = {
                    "scaled": scaledScore
                }
            }
            addCmi5DefinedToStatement(stmt);
            stmt.context.contextActivities.category.push(
            {
                "id": "https://w3id.org/xapi/cmi5/context/categories/moveon"
            });
            return stmt;
        }
        
        function addCmi5DefinedToStatement(stmt) {
            stmt.context = launchData.contextTemplate;
            stmt.context.contextActivities.category = [];
            stmt.context.contextActivities.category.push(
            {
                "id": "https://w3id.org/xapi/cmi5/context/categories/cmi5"
            });
        }
        
        var activityID = ADL.XAPIWrapper.lrs.extended.activityId;
        var actor = JSON.parse(ADL.XAPIWrapper.lrs.actor);
        var registration = ADL.XAPIWrapper.lrs.registration;
        var fetchURL = ADL.XAPIWrapper.lrs.extended.fetch;
        
        var launchData = {};
        var suspendData = {};

        (async () => {
            const fetchAuthToken = async () => {
                const response = await fetch(fetchURL, {
                    method: "POST"});
                const json = await response.json();
                console.log(json);
                return json["auth-token"];
            }
            var authToken = await fetchAuthToken();
            console.log("authToken", authToken);
        
            endPointConfig = {
                // "endpoint": endPoint,
                "auth": "Basic " + authToken
            };
            ADL.XAPIWrapper.changeConfig(endPointConfig);
        
            //var activityID = "http://cmi5wrapper.example/activity1"
            console.log("actor", actor);
            launchData = ADL.XAPIWrapper.getState(activityID, actor, "LMS.LaunchData", registration);
            console.log("launchData", launchData);
            suspendData = ADL.XAPIWrapper.getState(activityID, actor, "cmi.suspend_data", registration);
            console.log("suspendData", suspendData);
        })();
        
        var API = {
            LMSInitialize: function() {
                var stmt = makeBasicStatement(actor, ADL.verbs.initialized, activityID);
                addCmi5DefinedToStatement(stmt);
                var respObj = ADL.XAPIWrapper.sendStatement(stmt);
                console.log(respObj);
            },
            LMSGetValue: function(k) {
                
            },
            LMSSetValue: function(k, v) {
                if (k == "cmi.core.lesson_status") {
                    if (v == "passed") {
                        // TODO Unhardcode score.
                        var stmt = makePassedStatement(actor, ADL.verbs.passed, activityID, 0.95);
                        var respObj = ADL.XAPIWrapper.sendStatement(stmt);
                        console.log(respObj);
                    }
                }
            },
            LMSFinish: function() {
                
            },
            LMSGetLastError: function() {
                
            },
            LMSGetErrorString: function(errorCode) {
                
            },
            LMSGetDiagnostic(errocCode) {
                
            }
        };
        
        var API_1484_11 = {
            Initialize: function() {
                
            },
            Terminate: function() {
                
            },
            GetValue: function(k) {
                
            },
            SetValue: function(k) {
                
            },
            Commit: function() {
                
            },
            GetLastError: function() {
                
            },
            GetErrorString: function(errorCode) {
                
            },
            GetDiagnostic(errocCode) {
                
            }
        };
        
        
    </script>
</head>
<body>
    <iframe src="index.htm" width="100%" height="100%" style="position:absolute;top:0;bottom:0;left:0;right:0;overflow:hidden;" frameborder="0" scrolling="no" allowfullscreen></iframe>
</body>
</html>